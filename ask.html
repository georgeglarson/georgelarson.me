<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ask the resume - local search</title>
  <link rel="stylesheet" href="/style.css" />
  <meta name="description" content="Local, private search over George Larson's resume. Runs entirely in your browser with no trackers." />
</head>
<body>
  <main class="page">
    <h1>ask the resume<span class="caret" aria-hidden="true"></span></h1>
    <p class="lead">a privacy-first demo: everything runs locally against the same text that powers resume.txt.</p>
    <div class="searchbox">
      <input id="ask-query" type="text" placeholder="try: plc, ocr, linux, ai privacy" aria-label="search resume text" />
      <button id="ask-button" type="button">search</button>
    </div>
    <p><small class="hint">Tip: press Enter to submit. Results show the most relevant paragraphs with highlights.</small></p>
    <section id="ask-results" aria-live="polite"></section>
    <footer>
      <hr />
      <span>return to <a href="/index.html">home</a> / <a href="/resume.html">resume</a></span>
    </footer>
  </main>
  <script>
    const state = { paragraphs: [] };

    function escapeRegExp(str){
      return str.replace(/[.*+?^${}()|[\]\\]/g, "\\$&");
    }

    function scoreParagraph(text, terms){
      const lower = text.toLowerCase();
      let score = 0;
      terms.forEach(term => {
        if(!term) return;
        const re = new RegExp(escapeRegExp(term), "gi");
        const matches = lower.match(re);
        if(matches){
          const weight = term.length >= 3 ? 2 : 1;
          score += matches.length * weight;
        }
      });
      return score / Math.sqrt(text.length + 1);
    }

    function renderHighlight(container, text, terms){
      if(terms.length === 0){
        container.textContent = text;
        return;
      }
      const pattern = new RegExp("(" + terms.map(escapeRegExp).join("|") + ")", "gi");
      const lowerTerms = new Set(terms.map(t => t.toLowerCase()));
      const parts = text.split(pattern);
      parts.forEach(part => {
        if(part.length === 0) return;
        if(lowerTerms.has(part.toLowerCase())){
          const mark = document.createElement("mark");
          mark.textContent = part;
          container.appendChild(mark);
        }else{
          container.appendChild(document.createTextNode(part));
        }
      });
    }

    function search(query){
      const output = document.getElementById("ask-results");
      output.innerHTML = "";
      const terms = query.toLowerCase().split(/\s+/).filter(Boolean);
      if(terms.length === 0){
        output.innerHTML = '<p class="hint">Type a topic to search the resume.</p>';
        return;
      }
      const ranked = state.paragraphs
        .map(text => ({ text, score: scoreParagraph(text, terms) }))
        .filter(entry => entry.score > 0)
        .sort((a, b) => b.score - a.score)
        .slice(0, 6);
      if(ranked.length === 0){
        output.innerHTML = '<p class="hint">No strong matches. Try different terms or fewer words.</p>';
        return;
      }
      ranked.forEach(entry => {
        const wrapper = document.createElement("article");
        wrapper.className = "result";
        const meta = document.createElement("div");
        meta.className = "hint";
        meta.textContent = "score " + entry.score.toFixed(2);
        const body = document.createElement("p");
        renderHighlight(body, entry.text, terms);
        wrapper.appendChild(meta);
        wrapper.appendChild(body);
        output.appendChild(wrapper);
      });
    }

    async function loadResumeForSearch(){
      try{
        const res = await fetch("/resume.txt", {cache:"no-store"});
        if(!res.ok) throw new Error("fetch failed");
        const text = await res.text();
        state.paragraphs = text
          .split(/\n\s*\n/)
          .map(item => item.replace(/\s+/g, " ").trim())
          .filter(Boolean);
      }catch(err){
        const output = document.getElementById("ask-results");
        output.innerHTML = '<p class="hint">Unable to load resume.txt. Download it directly from the navigation.</p>';
      }
    }

    window.addEventListener("DOMContentLoaded", async () => {
      const input = document.getElementById("ask-query");
      const button = document.getElementById("ask-button");
      button.addEventListener("click", () => search(input.value.trim()));
      input.addEventListener("keydown", event => {
        if(event.key === "Enter"){
          event.preventDefault();
          search(input.value.trim());
        }
      });
      await loadResumeForSearch();
      const params = new URLSearchParams(window.location.search);
      const preset = params.get("q");
      if(preset){
        input.value = preset;
        search(preset.trim());
      }
    });
  </script>
</body>
</html>
