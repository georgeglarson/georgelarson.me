<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>resume - george larson</title>
  <link rel="stylesheet" href="/style.css" />
  <style>
    .lens-onboarding{
      margin: 1.75rem 0;
      padding: 1.25rem 1.5rem;
      border: 1px solid rgba(0, 255, 170, 0.35);
      border-radius: 0.75rem;
      background: rgba(0, 255, 170, 0.08);
      box-shadow: 0 0 25px rgba(0, 80, 55, 0.25);
    }
    .lens-onboarding h3{
      margin: 0 0 0.75rem 0;
      font-size: 1.15rem;
      letter-spacing: 0.02em;
      text-transform: uppercase;
    }
    .lens-steps{
      margin: 0 0 1rem 1.1rem;
      padding: 0;
      line-height: 1.6;
    }
    .lens-steps li{
      margin: 0 0 0.4rem 0;
    }
    .lens-steps li strong{
      color: rgba(0, 255, 170, 0.85);
    }
    .lens-demo-block{
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 0.75rem;
    }
    .lens-demo{
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      padding: 0.55rem 1.05rem;
      border-radius: 999px;
      border: 1px solid rgba(0, 255, 170, 0.75);
      background: rgba(0, 255, 170, 0.18);
      color: inherit;
      font-weight: 600;
      letter-spacing: 0.01em;
      transition: transform 0.15s ease, box-shadow 0.15s ease, background 0.15s ease;
    }
    .lens-demo:hover:not(:disabled){
      transform: translateY(-1px);
      box-shadow: 0 8px 18px rgba(0, 255, 170, 0.18);
      background: rgba(0, 255, 170, 0.28);
    }
    .lens-demo:focus-visible{
      outline: 2px solid rgba(0, 255, 170, 0.7);
      outline-offset: 2px;
    }
    .lens-demo:disabled{
      opacity: 0.55;
      cursor: not-allowed;
    }
    .lens-demo-block .hint{
      margin: 0;
      max-width: 32rem;
    }
    @media (max-width: 640px){
      .lens-onboarding{
        padding: 1.1rem 1.25rem;
      }
      .lens-demo-block{
        align-items: flex-start;
        flex-direction: column;
      }
    }
  </style>
  <meta name="description" content="Plain text resume for George Larson, director of technology and builder focused on pragmatic systems and privacy-aware AI." />
</head>
<body>
  <main class="page">
    <h1>resume.txt<span class="caret" aria-hidden="true"></span></h1>
    <p class="lead">rendered directly from the source text for printing, diffing, and quick scans.</p>
    <nav class="resume-actions" aria-label="resume shortcuts">
      <a class="pill-link" href="#resume-text">Jump to resume</a>
      <a class="pill-link" href="#lens-tools">Explore AI summaries</a>
    </nav>

    <section class="lens" id="lens-tools" aria-label="resume lenses">
      <h2>optional: view the resume through a specific lens</h2>
      <p class="hint">Live summaries run on Cloudflare using the Hugging Face Inference API (token stays server-side). Saved lenses remain available for quick scanning.</p>
      <div class="lens-onboarding" role="note">
        <h3>How to explore</h3>
        <ol class="lens-steps">
          <li><strong>Preview</strong> a saved lens to see an instant AI summary.</li>
          <li><strong>Describe</strong> the focus you care about (or tap a prompt below).</li>
          <li><strong>Generate</strong> to get a tailored overview and reading path.</li>
        </ol>
        <div class="lens-demo-block">
          <button type="button" id="lens-demo" class="lens-demo">Watch a quick demo</button>
          <p class="hint">The demo runs the first quick lens ("AI + privacy") so you can observe the status updates.</p>
        </div>
      </div>

      <div class="lens-live">
        <h3>Generate a fresh take</h3>
        <form id="lens-form" class="lens-form">
          <label class="lens-field">
            <span>Focus</span>
            <input id="lens-input" type="text" name="lens" maxlength="240" placeholder="e.g., AI privacy, manufacturing uptime, leadership style" required />
          </label>
          <label class="lens-field">
            <span>Model</span>
            <select id="lens-model" name="model">
              <option value="@cf/meta/llama-3-8b-instruct">Llama 3 8B Instruct (default, recommended)</option>
              <option value="@cf/mistral/mistral-7b-instruct-v0.1">Mistral 7B Instruct</option>
              <option value="@hf/thebloke/neural-chat-7b-v3-1-awq">Neural Chat 7B</option>
              <option value="@cf/meta/llama-2-7b-chat-int8">Llama 2 7B Chat</option>
            </select>
          </label>
          <button type="submit" id="lens-submit">Generate summary</button>
        </form>
        <p class="hint">Need ideas? These prompts showcase how the tool reacts.</p>
        <div class="lens-suggestions" id="lens-suggestions" aria-label="Quick lens suggestions"></div>
        <div id="lens-status" class="hint" role="status" aria-live="polite">Type a focus, tap a prompt, or run the demo above, then press Enter to generate your custom summary.</div>
        <article id="live-detail" class="lens-panel" aria-live="polite">
          <h3>What you'll see</h3>
          <p>The live lens rewrites the resume for the focus you provide and points you to the sections worth skimming.</p>
          <ul class="plain-list">
            <li>Use the demo button or try a suggestion above, then describe the angle you're hiring for.</li>
            <li>Summaries generate in a few seconds and stay on this page.</li>
          </ul>
        </article>
      </div>

      <div class="lens-saved">
        <h3>Saved lenses</h3>
        <div id="lens-menu" class="lens-buttons" role="tablist" aria-label="Available resume lenses"></div>
        <article id="lens-detail" class="lens-panel" role="tabpanel" tabindex="0" aria-live="polite">
          <p class="hint">Select a saved lens to see an AI-assisted summary and suggested reading inside the resume.</p>
        </article>
      </div>
    </section>

    <pre id="resume-text">loading resume...</pre>
    <footer>
      <hr />
      <span>return to <a href="/index.html">home</a> / <a href="/schedule.html">schedule time</a></span>
    </footer>
  </main>
  <script>
    const QUICK_LENSES = [
      { title: "AI + privacy", prompt: "How does George apply AI while guarding privacy and regulated data?" },
      { title: "Manufacturing ops", prompt: "Explain George's manufacturing, PLC, and uptime experience." },
      { title: "Technology leadership", prompt: "Summarise how George leads teams and ships roadmaps." },
      { title: "Meditation influence", prompt: "Connect George's Zen practice to his leadership style." },
      { title: "Baker?", prompt: "Evaluate George's resume as if he were interviewing for a baker role." }
    ];

    const state = {
      resumeText: "",
      lenses: [],
      selectedLens: null,
      liveResult: null,
      loading: false
    };
    const DEFAULT_STATUS = "Type a focus, tap a prompt, or run the demo above, then press Enter to generate your custom summary.";

    async function loadResume(){
      const target = document.getElementById("resume-text");
      try{
        const res = await fetch("/resume.txt", {cache:"no-store"});
        if(!res.ok) throw new Error("fetch failed");
        state.resumeText = (await res.text()).trim();
        target.textContent = state.resumeText;
      }catch(err){
        target.textContent = "Resume could not be loaded. Please download it directly at /resume.txt.";
      }
    }

    function renderSavedLens(lens){
      const detail = document.getElementById("lens-detail");
      if(!lens){
        detail.innerHTML = '<p class="hint">Select a saved lens to see an AI-assisted summary and suggested reading inside the resume.</p>';
        detail.setAttribute("aria-label", "lens summary");
        return;
      }
      const points = lens.key_points || [];
      const terms = lens.recommended_terms || [];
      const notes = lens.source_notes || [];
      detail.setAttribute("aria-label", lens.title + " summary");
      detail.innerHTML = `
        <h3>${lens.title}</h3>
        <p>${lens.summary}</p>
        ${points.length ? `<ul class="plain-list">${points.map(item => `<li>${item}</li>`).join("")}</ul>` : ""}
        ${terms.length ? `<p class="hint">jump-start a deeper dive:</p>
          <div class="tag-list">${terms.map(term => `<a class="tag" href="/ask.html?q=${encodeURIComponent(term)}" title="Search the resume for ${term}">${term}</a>`).join("")}</div>` : ""}
        ${notes.length ? `<p class="hint">source sections: ${notes.join(", ")}</p>` : ""}
      `;
    }

    function renderLive(result){
      const panel = document.getElementById("live-detail");
      if(!result){
        panel.innerHTML = `
          <h3>What you'll see</h3>
          <p>The live lens rewrites the resume for the focus you provide and points you to the sections worth skimming.</p>
          <ul class="plain-list">
            <li>Try a suggestion above or describe the angle you're hiring for.</li>
            <li>Summaries generate in a few seconds and stay on this page.</li>
          </ul>
        `;
        return;
      }
      const bullets = result.key_points || [];
      panel.innerHTML = `
        <h3>Live lens: ${result.lens}</h3>
        <p>${result.summary}</p>
        ${bullets.length ? `<ul class="plain-list">${bullets.map(item => `<li>${item}</li>`).join("")}</ul>` : ""}
        <p class="hint">Generated with ${result.model} at ${new Date(result.generated_at || Date.now()).toLocaleTimeString()}.</p>
      `;
    }

    function mountLensMenu(){
      const menu = document.getElementById("lens-menu");
      menu.innerHTML = "";
      if(!state.lenses.length){
        menu.innerHTML = '<p class="hint">Saved lenses are unavailable right now.</p>';
        return;
      }
      state.lenses.forEach((lens, index) => {
        const button = document.createElement("button");
        button.className = "lens-button";
        button.type = "button";
        button.textContent = lens.title;
        button.setAttribute("role", "tab");
        const isSelected = state.selectedLens === lens.id;
        button.setAttribute("aria-selected", isSelected ? "true" : "false");
        button.setAttribute("tabindex", isSelected ? "0" : "-1");
        button.addEventListener("click", () => {
          state.selectedLens = lens.id;
          renderSavedLens(lens);
          [...menu.children].forEach(child => {
            child.setAttribute("aria-selected", child === button ? "true" : "false");
            child.setAttribute("tabindex", child === button ? "0" : "-1");
          });
          button.focus();
        });
        menu.appendChild(button);
        if(index === 0 && !state.selectedLens){
          state.selectedLens = lens.id;
          renderSavedLens(lens);
          button.setAttribute("aria-selected", "true");
          button.setAttribute("tabindex", "0");
        }else if(!isSelected){
          button.setAttribute("aria-selected", "false");
          button.setAttribute("tabindex", "-1");
        }
      });
    }

    async function loadLenses(){
      try{
        const res = await fetch("/data/resume_lenses.json", {cache:"no-store"});
        if(!res.ok) throw new Error("fetch failed");
        const data = await res.json();
        state.lenses = data.lenses || [];
        state.selectedLens = null;
      }catch(err){
        state.lenses = [];
        const detail = document.getElementById("lens-detail");
        detail.innerHTML = '<p class="hint">Saved lenses could not be loaded. You can regenerate them with scripts/generate_lenses.py.</p>';
      }
      mountLensMenu();
    }

    function mountSuggestions(){
      const container = document.getElementById("lens-suggestions");
      container.innerHTML = "";
      QUICK_LENSES.forEach(item => {
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "lens-suggestion";
        btn.textContent = item.title;
        btn.addEventListener("click", () => {
          const input = document.getElementById("lens-input");
          input.value = item.prompt;
          input.focus();
        });
        container.appendChild(btn);
      });
    }

    function runDemoLens(){
      if(state.loading) return;
      if(!QUICK_LENSES.length) return;
      const demo = QUICK_LENSES[0];
      const input = document.getElementById("lens-input");
      input.value = demo.prompt;
      input.focus();
      requestLensSummary(demo.prompt, document.getElementById("lens-model").value);
    }

    function setLoading(isLoading, message){
      state.loading = Boolean(isLoading);
      const status = document.getElementById("lens-status");
      status.textContent = message || DEFAULT_STATUS;
      const submit = document.getElementById("lens-submit");
      submit.disabled = state.loading;
      const demoButton = document.getElementById("lens-demo");
      if(demoButton){
        demoButton.disabled = state.loading;
      }
      submit.textContent = state.loading ? "Generating..." : "Generate summary";
    }

    function showStatus(message){
      const status = document.getElementById("lens-status");
      status.textContent = message || DEFAULT_STATUS;
    }

    async function handleGeneration(event){
      event.preventDefault();
      if(state.loading) return;
      const input = document.getElementById("lens-input");
      const modelSelect = document.getElementById("lens-model");
      const lensText = input.value.trim();
      if(!lensText){
        showStatus("Please describe the lens you want to explore.");
        return;
      }
      await requestLensSummary(lensText, modelSelect.value);
    }

    async function requestLensSummary(lensText, model, attempt = 1){
      setLoading(true, attempt === 1 ? "Generating your summary..." : `Retrying (attempt ${attempt})...`);
      try{
        const response = await fetch("/api/lens-summary", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ lens: lensText, model })
        });
        const data = await response.json().catch(()=>({}));
        if(!response.ok){
          if(response.status === 503 && attempt < 3){
            showStatus("Model is waking up (about 10 seconds). We'll retry automatically.");
            setTimeout(() => requestLensSummary(lensText, model, attempt + 1), 7000);
            setLoading(false, "");
            return;
          }
          throw new Error(data.error || `Generation failed (status ${response.status}).`);
        }
        state.liveResult = data;
        renderLive(data);
        setLoading(false, "Summary ready. Scroll down to review the recommended sections.");
      }catch(err){
        console.error(err);
        setLoading(false, "");
        showStatus(err.message || "Generation failed. Please try again.");
      }
    }

    function shouldWarm(){
      try{
        const key = "gl-lens-warm";
        const stored = sessionStorage.getItem(key);
        const today = new Date().toISOString().slice(0,10);
        if(stored === today) return false;
        sessionStorage.setItem(key, today);
        return true;
      }catch{
        return true;
      }
    }

    async function warmModel(){
      if(!shouldWarm()) return;
      const model = document.getElementById("lens-model").value;
      try{
        const res = await fetch("/api/lens-summary", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ lens: "Warm up request to keep the model ready.", model })
        });
        if(res.status === 503){
          console.info("Model warming up; retrying in 10s.");
          setTimeout(warmModel, 10000);
        }
      }catch(err){
        console.warn("Warm-up failed", err);
      }
    }

    window.addEventListener("DOMContentLoaded", async () => {
      mountSuggestions();
      renderLive(null);
      document.getElementById("lens-form").addEventListener("submit", handleGeneration);
      const demoButton = document.getElementById("lens-demo");
      if(demoButton){
        demoButton.addEventListener("click", runDemoLens);
      }
      await loadResume();
      await loadLenses();
      warmModel();
    });
  </script>
</body>
</html>
